<!DOCTYPE html>
<html>
<head>
	<title>Health Bank</title>
	<meta charset="UTF-8">
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  	<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
	<script src="../js/healthbank.js"></script>
	<link href="../css/healthbank.css" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />


	<script type="text/javascript">

		function loadUsersIcon(data, userId){
			$("#"+userId).attr("src", "data:image/png;base64,"+data);
			$("#"+userId).attr("height", "30px");
		}

		function loadUserInfo(data){
			if(data==undefined){ 
				/* Do nothing for the moment */ 
				console.log("data undefined in loadUserInfo()");
				return;
			}
			if(data.userIcon!=undefined){
				$("#userInfo").html(decodeURIComponent(data.username));
				loadImage(data.userIcon, "", {onSuccess: function(data){loadUserIcon(data);}});
			} else {
				$("#userInfo").html("Logged in as: "+decodeURIComponent(data.username));
			}
		}

		function loadUserIcon(data){
			$("#userInfo").html("<img src=\"data:image/png;base64,"+data+"\" height=\"25px\"/>"+$("#userInfo").html());
			$(".detail-icon").html("<img src=\"data:image/png;base64,"+data+"\" width=\"50px\"/>");
			$(".detail-icon").css("display", "block");
		}

		function loadQueryResult(data) {
			$("#usersearchresults").html("<center>Search result:</center>");
			if(data.values.users==0){
				$("#usersearchresults").append("<center>No users found for this query!</center>");
			}

			records = data.values.users;
			$("#usersearchresults").remove(".usersearch-box");
			$.each(data.values.users, function(i, item) {
				var userId = decodeURIComponent(item.userId.$oid);
			    if(item.userIcon!=undefined){
					loadImage(item.userIcon, userId, {onSuccess: function(result, id){loadUsersIcon(result, id);}, onError: function(result){if(result.loggedOut==true){}}});
					$("#usersearchresults").append('<div userid="'+userId+'" class="usersearch-box"><img id="'+userId+'" class="usersearch-itemImage"/><h3 class="usersearch-itemheader">'+decodeURIComponent(item.firstname)+' '+decodeURIComponent(item.lastname)+'</div></li>'); 
				} else {
					$("#usersearchresults").append('<div class="usersearch-box" userid="'+userId+'"><h3 class="usersearch-itemheader">'+decodeURIComponent(item.firstname)+' '+decodeURIComponent(item.lastname)+'</div></li>'); 
				}
			    if(i==10){
			    	return false;
			    }
			});
			$("#usersearchresults div").draggable({
				containment: '.page-content',
				cursor: 'move',
				snap: '.page-content',
				helper: 'clone'
			} );
			$("#usersearchresults div").click(function(){ 
				// TODO
			});
			$("#loader").hide();
		}
		function loadQueryResultError() {
			$("#usersearchresults").html("<center style=\"color: red\">Sorry we could not find any user with this name!</center>");
		}

		function handleDropEvent( event, ui, ele ){
			var draggable = ui.draggable;
			if(ele.attr("id")=="addCircle"){
				$( "#notYetImplementedDialog" ).dialog( "open" );
			} else {
				//alert( 'The square with ID "' + draggable.attr('userid') + '" was dropped onto the circle "'+ele.attr('id')+'"!' );
				$.each(circles, function(i, item){
					if(ele.attr("name")==item.name){
						addItemToCircle(item._id.$oid, draggable.attr('userid'), {
							onSuccess: function(data){
								loadCircles({onSuccess: function(data){loadedCircles(data);}, onError: function(){console.log("Error while loading circles...");}});
							}
						});
						return false;
					}
				});
			}
		}

		var usersInCircles = [];
		var fam=0, fri=0, med=0, wel=0;

		function loadedCircles(data){
			if(data.values.circles.size==0){
				return false;
			}
			usersInCircles = [];
			circles = data.values.circles;
			$.each(circles, function(i, item){
				switch(item.name){
					case "Family":
						fam=(item.users!=undefined)?item.users.length:0;
						break;
					case "Friends":
						fri=(item.users!=undefined)?item.users.length:0;
						break;
					case "Medical Professionals":
						med=(item.users!=undefined)?item.users.length:0;
						break;
					case "Wellness Professionals":
						wel=(item.users!=undefined)?item.users.length:0;
						break;
					default:
						break;
				}
				var user;
				if(item.users!=undefined){
					$.each(item.users, function(j, id) {
						var found = -42;
						$.each(usersInCircles, function(k, u){
							if(u["id"]==id.userId){found = k;}
						});
						if(found==-42) {
							user = [];
							user["id"] = id.userId;
							usersInCircles.push(user);
							queryUsers(id.userId, {onSuccess: function(data){ // async!!
								var curUser = data.values.users[0];
								$.each(usersInCircles, function(k, u){ if(u["id"]==id.userId){found = k;} });
								usersInCircles[found]["firstname"] = curUser.firstname;
								usersInCircles[found]["lastname"] = curUser.lastname;
								var circles = [];
								circles.push(item.name);
								usersInCircles[found]["circles"] = circles;
								if(curUser.userIcon!=undefined){
									loadImage(data.userIcon, id.userId, {
										onSuccess: function(data, userId){
											$.each(usersInCircles, function(k, u){ if(u["id"]==id.userId){found = k;} });
											usersInCircles[found]["img"] = data;
										}, onError: function(data){console.log(data);}
									});								} else {
									$("#circleentries").append('<div class="usersearch-box" userid="'+id.userId+'"><h3 class="usersearch-itemheader">'+decodeURIComponent(curUser.firstname)+' '+decodeURIComponent(curUser.lastname)+'</div></li>'); 
								}
							}}); // end async!!
						} else {
							setTimeout(function(){usersInCircles[found]["circles"].push(item.name);}, 500);
						}
					});
				}
			});
			setCirclesText();
		}

		function setCirclesText(){
			$("#familyCircle span").html("Family "+fam);
			$("#friendsCircle span").html("Friends "+fri);
			$("#medicalCircle span").html("Medical Prof. "+med);
			$("#wellnessCircle span").html("Wellness Prof. "+wel);
			$("#addCircle span").html('<svg xmlns="http://www.w3.org/2000/svg" version="1.1"><rect x="28" y="2" rx="5" ry="20" width="12" height="64" style="fill:#8B814C;stroke:black;stroke-width:2;opacity:0.9" /><rect x="2" y="26" rx="20" ry="5" width="64" height="12" style="fill:#8B814C;stroke:black;stroke-width:2;opacity:0.9" /></svg>')
		}

		function addUserImagesToCircle(name){
			$("#loader").show();
			$("#usersearchresults").html("<center>Users in Circle "+name+":</center><button value='"+name+"' id='spacesButton' class=\"list-button spaceButton\">Spaces</button>");
			if(usersInCircles.length==0){
				$("#usersearchresults").append("<center>You have no users in your circles yet!</center>");
			}
			$.each(usersInCircles, function(i, item){
				$.each(item["circles"], function(j, circle){
					if(circle==name){
						$("#usersearchresults").append('<div userid="'+item["id"]+'" class="usersearch-box"><img id="'+item["id"]+'" src="data:image/png;base64,'+item["img"]+'" class="usersearch-itemImage"/><h3 class="usersearch-itemheader">'+item["firstname"]+' '+item["lastname"]+'</div></li>');
					}
				});
			});
			$("#usersearchresults div").draggable({
				containment: '.page-content',
				cursor: 'move',
				snap: '.page-content',
				helper: 'clone'
			} );
			$("#usersearchresults div").click(function(){ 
				// TODO
			});
			$("#loader").hide();
			$("#spacesButton").click(function(){				
				$( "#notYetImplementedDialog" ).dialog( "open" );
			});
		}

		function setCirclePos() {
			$(".fam").offset({ top: $(".me").offset().top-60, left: $(".me").offset().left-30});
			$(".friend").offset({ top: $(".me").offset().top-50, left: $(".me").offset().left+ 1/2*$(".me").width()+10});
			$(".med").offset({ top: $(".me").offset().top+1/3*$(".me").height(), left: $(".me").offset().left-70});
			$(".wel").offset({ top: $(".me").offset().top+1/2*$(".me").height()-20, left: $(".me").offset().left+1/2*$(".me").width()+50});
			$(".aNew").offset({ top: $(".me").offset().top+$(".me").height()-40, left: $(".me").offset().left+1/6*$(".me").width()});
		}

		$(document).ready(function() {
			checkLogin();
			setSearchAnimation();
			getUserData({onSuccess: function(data){loadUserInfo(data);}});
			loadCircles({onSuccess: function(data){loadedCircles(data);}, onError: function(){console.log("Error while loading circles...");}});
			$("#logoutButton").click(function(){
				logout();
				return false;
			});
			$("#userInfo").click(function(){
				window.location = WEB_URL+"profile.html";
			});
		    $('.circle').mouseover(function() {
		        $("#"+this.id).addClass('circle-hover');
		    });
		    $('.circle').mouseout(function() {
		        $("#"+this.id).removeClass('circle-hover');
		    });
		    $('.circle').click(function() {
		        if($(this).attr('id')!="addCircle"){
		        	addUserImagesToCircle($(this).attr("name"));
		        }
		    });
		    $('.circle').droppable( {
		    	over: function(event, ui) {
		    		$("#"+$(this).attr('id')).addClass('circle-hover');
		    		if($(this).attr('id')!="addCircle"){
		    			$("#"+$(this).attr('id')+" span").html("Add user!");
		    		} else {
		    			$("#"+$(this).attr('id')+" span").html("New circle!");
		    		}
		    	},
		    	out: function(event, ui) {
		    		setCirclesText();
		    	},
				drop: function(event, ui) {
					handleDropEvent(event, ui, $(this));
					setCirclesText();
				}
			} );
		    $("#searchButton").click(function(){
				var query = $("#usersearchbar").val();
				$("#loader").show();
		    	queryUsers(query, {onSuccess: function(data){loadQueryResult(data);}, onError: function(){console.log("onError"); loadQueryResultError();}});
		    });
		    $("#usersearchbar").keyup(function(event){
			    if(event.keyCode == 13){
			        $("#searchButton").click();
			    }
			});
			$("#search").keyup(function(event){
			    if(event.keyCode == 13){
			    	if($("#search").val()!=undefined && $("#search").val().length>0){
			    		if(typeof(Storage)!=="undefined") {
							localStorage.setItem("hb_query", $("#search").val());
						}
			        	window.location = WEB_URL + "queryResult.html?";
			       	}
			    }
			});
			$( "#notYetImplementedDialog" ).dialog({
				autoOpen: false,
				show: {
					effect: "slide",
					duration: 500
				},
				hide: {
					effect: "scale",
					duration: 500
				}
			});
			$("#addCircle").click(function(){
				$( "#notYetImplementedDialog" ).dialog( "open" );
			});
			setCirclePos();
			$(window).resize(function() {
			  setCirclePos();
			});
		});
		
	</script>
</head>
<body>
	<!--Header-->
	<h1 class="heading">Welcome to the Health Bank<sup>&copy;</sup></h1>
	<!--END Header-->

	<!--Page-->
	<div id="hb-page">
		<div class="page-container">
			<!--Header-->
			<div class="page-header">
				<h1>Circle Manager</h1> 
				<div class="page-actionbox">
					<span id="userInfo" class="userInfo"></span>
					<input id="logoutButton" type="submit" name="submit" value="Logout" class="page-logout-button" />
					<div class="searchbox">
						<span id="searchIconSpan"><img id="searchIcon" src="../images/search-icon.png"/></span>
						<input id="search" type="text" x-webkit-speech/>
					</div>
				</div>
			</div>
			<!--END Header-->

			<div class="page-content-container">
				<!--Navi-->
				<ul id="navivation" class="page-navi">
					<li><a href="home.html">Home</a></li>
					<li><a href="profile.html">Profile</a></li>
					<li><a href="spaces/spaces.html">Spaces</a></li>
					<li class="selectedLi"><a href="circles.html">Circles</a></li>
					<li><a href="apps.html">Apps</a></li>
					<li><a href="community.html">Community</a></li>
					<li><a href="about.html">About</a></li>
				</ul>
				<!--END Navi-->

				<!--Content-->
				<div class="page-content">
					<table id="contentTable">
						<tr class="searchTr">
							<td>
								<div id="usersearch">
									<div class="searchbar">
										<label for="usersearchbar" id="usersearchlabel" class="label">Search for other users</label>
										<input type="search" id="usersearchbar" class="input"></input>
									</div>
									<input id="searchButton" type="submit" name="submit" value="Search" class="big-button searchButton" />
								</div>
							</td>
						</tr>
						<tr class="resTr">
							<td height="100%" id="dashbox">
								<div id="usersearchresults" class="recordentries">
									<center>
										<img id="loader" style="height:60px; float:center; display: none; margin-left: auto; margin-right: auto;" src="../images/loading.gif"></img>
										Use the search bar above to search for users.
									</center>
								</div>
							</td>
						</tr>
						<tr class="circleTr">
							<td>
								<div id="circles">
									<div class="me" id="meCircle"><span style="line-height: 250px;">Me</span></div>
									<div class="circle fam" id="familyCircle" name="Family"><span>Family 0</span></div>
									<div class="circle friend" id="friendsCircle" name="Friends"><span>Friends 0</span></div>
									<div class="circle med" id="medicalCircle" name="Medical Professionals"><span>Medical Prof. 0</span></div>
									<div class="circle wel" id="wellnessCircle" name="Wellness Professionals"><span>Wellness Prof. 0</span></div>
									<div class="circle aNew" id="addCircle">
										<span>
											<svg xmlns="http://www.w3.org/2000/svg" version="1.1">
												<rect x="28" y="2" rx="5" ry="20" width="12" height="64" style="fill:#8B814C;stroke:black;stroke-width:2;opacity:0.9" />
												<rect x="2" y="26" rx="20" ry="5" width="64" height="12" style="fill:#8B814C;stroke:black;stroke-width:2;opacity:0.9" />
											</svg>
										</span>
									</div>
								</div>
							</td>
						</tr>
					</table>
				</div>
				<!--END Content-->
			</div>
		</div>
	</div>
	<!--END Page-->
	
	<!--Bg Gradient--><div class="gradient-page"></div><!--END Bg Gradient-->
	
	<!-- Bottom Bar -->
    <div class="hb-bottom">
		<span class="disclaimer">This is a project by Health Bank<sup>&copy;</sup>. All rights reserved. This website was elaborated by Patrick Tremp for his Master thesis.<span>
    	
        <span class="right">
    		<a href="http://www.healthbank.ch">
    			<img src="../images/logo.png" style=" margin-top:6px; height: 38px;" title="To Health Bank" alt="ETHZ" />
    		</a>
    	</span>
    	<div class="clr"></div>
    </div>
	<!--END Bottom Bar -->

	<!-- DIALOGS -->
	<div id="notYetImplementedDialog" title="Not yet implemented!">
		<p>We are very sorry, but this feature is not yet implemented. Stay tuned to find it working hopefully pretty soon. </p>
	</div>
	<!-- END DIALOGS-->
</body>
</html>