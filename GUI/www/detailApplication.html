<!DOCTYPE html>
<html>
<head>
	<title>Health Bank</title>
	<meta charset="UTF-8">
	<link rel="shortcut icon" type="image/x-icon" href="../images/favicon.ico">
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<script src="../js/healthbank.js"></script>
	<script src="../js/moment.min.js"></script>
	<link href="../css/healthbank.css" rel="stylesheet" type="text/css">

	<script type="text/javascript">
		var id, type, url, mydata;
		var hasInstalled = false;

		function loadUserInfoIndividual(data){
			if(data.type=="institute" || data.type=="admin"){
				$(".appDevCont").show();
			} else {
				$(".appDevCont").hide();
				$("#commNavEntry").css("margin-top", "90px");
			}
		}

		function install () {
			if(hasInstalled){return false;}
			inAndUninstallApplication(id, {
				onSuccess: function(data){
					$("#feedback").html("Installation successfull.");
					$("#feedback").css("color", "green");
					hasInstalled = true;
					$("#installButton").val("Uninstall");
					$("#installButton").click( function(){
						uninstall();
					});
					$("#openAppButton").show();
				}, onError: function(data) {
					$("#feedback").html("There was an error installing the application. Please try again.");
					$("#feedback").css("color", "red");
				}
			});
		}

		function uninstall () {
			if(!hasInstalled){return false;}
			inAndUninstallApplication(id, {
				onSuccess: function(data){
					$("#feedback").html("Successfully uninstalled.");
					$("#feedback").css("color", "green");
					hasInstalled = false;
					$("#installButton").val("Install");
					$("#installButton").click( function(){
						install();
					});
					$("#openAppButton").hide();
				}, onError: function(data) {
					$("#feedback").html("There was an error uninstalling the application. Please try again.");
					$("#feedback").css("color", "red");
				}
			});
		}

		function initInstallButton () {
			getInstalledApplications(type, {
				onSuccess: function(data){
					mydata = undefined;
					if(type=="app"){
						mydata = data.values.applications;
					} else if(type="viz"){
						mydata = data.values.visualizations;
					}
					$.each(mydata, function(i, item){
						if(item._id.$oid == id){
							hasInstalled = true;
							return false;
						}
					});
					if(hasInstalled){
						$("#installButton").val("Uninstall");
						$("#installButton").click( function(){
							uninstall();
						});
					} else {
						$("#installButton").click( function(){
							install();
						});
						$("#openAppButton").hide();
					}
				}, onError: function(data){
					hasInstalled = false;
					$("#installButton").click( function(){
						install();
					});
					$("#openAppButton").hide();
				}
			});
		}

		function loadApplication(){
			id = getURLParameter("id");
			type = getURLParameter("type");
			if(id!=undefined && type!=undefined){
				getApplicationDetail(id, type, {
					onSuccess: function(data){
						mydata = undefined;
						if(type=="app"){
							mydata = data.values.applications[0];
							$("#openAppButton").click(function(){
								window.location = WEB_URL + "appView.html?id="+id; 
							});
						} else if(type="viz"){
							mydata = data.values.visualizations[0];
							$("#openAppButton").hide();
						}

						$("#name").html(mydata.name);
						$("#descr").html("<b>Description: </b></br>"+mydata.descr);
						if(mydata.whatIsNew!=undefined && mydata.whatIsNew.length>0){$("#whatIsNew").html("<b>What is new?: </b></br>"+mydata.whatIsNew);}
						$("#info").html("&nbsp;&nbsp;&nbsp;<b>Author: </b><font id=\"authorID\" value=\""+mydata.companyID+"\">"+mydata.companyName+"</font></br>&nbsp;&nbsp;&nbsp;<b>Created on: </b>"+moment(mydata.timedate).format('MMMM Do YYYY')+"</br>&nbsp;&nbsp;&nbsp;<b>Version: </b>"+mydata.version+"</br>&nbsp;&nbsp;&nbsp;<b>Installs so far: </b>"+mydata.nrOfInstalls);
						if(mydata.icon!=undefined){
							loadImage(mydata.icon, "", "application", {
								onSuccess: function(data, id){
									$("#icon").attr("src", "data:image/png;base64,"+data);
								}, onError: function(data){
									$("#icon").attr("src", WEB_URL+'../images/news-icon.jpg');
								}
							});
						}
					}, 
					onError: function(data){
						$("#feedback").html("There was an error loading the application. Please try again.");
						$("#feedback").css("color", "red");
					}
				});
			} else {
				$("#feedback").html("There was an error loading the application. Please try again.");
				$("#feedback").css("color", "red");
			}
		}

		$(document).ready(function() {
			initialize();
			loadApplication();
			initInstallButton();
			$("#backButton").click(function(){
				url = getURLParameter("url");
				if(url!=undefined){ window.location = WEB_URL + url; }
				else { 
					if(type!=undefined && type=="viz"){
						window.location = WEB_URL + "market.html?type=viz"; 
					} else {
						window.location = WEB_URL + "market.html"; 
					}
				}
				return false;
			});
		});
		
	</script>
</head>
<body>
	<!--Page-->
	<div id="hb-page">
		<div class="page-container">
			<!--Header-->
			<div class="page-header">
				<h1>Application Detail</h1> 
				<div class="page-actionbox"></div>
			</div>
			<!--END Header-->

			<div class="page-content-container">
				<!--Navi-->
				<div id="nav-container"></div>
				<!--END Navi-->

				<!--Content-->
				<div class="page-content">
					<div id="feedback" class="detailAppFeedback"></div>
					<div id="appInfoBox">
						<img id="icon" class="appIcon"/>
						<div class="appNameInfoBox">
							<h3 id="name" class="appName"> </h3></br>
							<div id="info" class="appInfo"></div>
						</div>
					</div>
					</br>
					<div id="descr" class="appDescr"></div></br>
					<div id="whatIsNew" class="appWhatsNew"> </div>
					</br></br></br>
					<button id="backButton" class="button">Back</button>
					<input id="installButton" type="submit" name="submit" value="Install" class="button" />
					<button id="openAppButton" class="button">Open Application</button>
				</div>
				<!--END Content-->
			</div>
		</div>
	</div>
	<!--END Page-->
	
	<!--Bg Gradient--><div class="gradient-page"></div><!--END Bg Gradient-->
	
	<!-- Bottom Bar -->
    <div class="hb-bottom">
		<span class="disclaimer">This is a project by Health Bank<sup>&copy;</sup>. All rights reserved. This website was elaborated by Patrick Tremp for his Master thesis.</span>
        <span class="centerDisclaimer">If you encounter any problem on the page, please inform us <a href="http://goo.gl/zo8FBu">here</a></span>
    	
        <span class="right">
    		<a href="http://www.healthbank.ch">
    			<img src="../images/logo.png" style=" margin-top:6px; height: 38px;" title="To Health Bank" alt="ETHZ" />
    		</a>
    	</span>
    	<div class="clr"></div>
    </div>
	<!--END Bottom Bar -->
</body>
</html>