<!DOCTYPE html>
<html>
<head>
	<title>Health Bank</title>
	<meta charset="UTF-8">
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script src="../../js/healthbank.js"></script>
	<link href="../../css/healthbank.css" rel="stylesheet" type="text/css">

	<script type="text/javascript">

		var records, circles;
		var circlesLoaded = false;

		function loadUserIcon(data){
			$("#userInfo").html("<img src=\"data:image/png;base64,"+data+"\" height=\"25px\"/>"+$("#userInfo").html());
			$(".detail-icon").html("<img src=\"data:image/png;base64,"+data+"\" width=\"50px\"/>");
			$(".detail-icon").css("display", "block");
		}

		function loadUserInfo(data){
			if(data==undefined){ 
				/* Do nothing for the moment */ 
				console.log("data undefined in loadUserInfo()");
				return;
			}
			if(data.userIcon!=undefined){
				$("#userInfo").html(decodeURIComponent(data.username));
				loadImage(data.userIcon, "", {onSuccess: function(data){loadUserIcon(data);}});
			} else {
				$("#userInfo").html("Logged in as: "+decodeURIComponent(data.username));
			}
		}

		function loadLatestRecords(data) {
			$("#recordentries").html("");
			if(data.values.records==0){
				$("#recordentries").append("<center>No entries yet!</center>");
				return false;
			}
			data.values.records.reverse();
			records = data.values.records;
			$.each(data.values.records, function(i, item) {
			    $("#recordentries").append('<li><h3 class="recordlist-itemheader">'+decodeURIComponent(item.name)+'</h3><i>Created at: '+item.timedate+'</i><button value="'+item._id.$oid+'" class=\"list-button spaceButton\">Spaces</button><button value="'+item._id.$oid+'" class=\"list-button circleButton\">Circles</button></li>');
			});
			$(".recordlist-itemheader").click(function(){ 
				if(typeof(Storage)!=="undefined") {
					localStorage.setItem("hb_detailId", records[$(this).parent().index()]._id.$oid);
					localStorage.setItem("hb_backlink", "spaces/spaces.html");
				}
				window.location = WEB_URL+"detailRecord.html"; 

			});
		    $(".circleButton").click(function(){
				$('#circles-form').height("320px");
				var maskHeight = $(document).height();  
	    		var maskWidth = $(window).width();
	    		var dialogTop =  (maskHeight/2) - ($('#circles-form').height()/2);  
	    		var dialogLeft = (maskWidth/2) - ($('#circles-form').width()/2);
	    		$('#dialog-overlay').css({height:maskHeight, width:maskWidth}).show();
	    		$('#circles-form').css({top:dialogTop, left:dialogLeft}).show();
	    		$(".circles-form label").autoWidth();
	    		$("#recordID").val($(this).val())
	    		$("#circle").contents().remove();
	    		$.each(circles, function(i, item){
	    			$("#circle").append("<option value=\""+item.name+"\">"+item.name+"</option>");
	    		});
				return false;
		    });
		    $(".spaceButton").click(function(){
		    	alert("Not yet implemented! "+$(this).val()); // This
		    	return false;
		    });
		}
		function loadRecordsError() {
			$("#recordentries").html("<center style=\"color: red\">Either you have no entries yet or there was an error!</center>");
			console.log("onError");
		}

		function loadedCircles(data){
			if(data.values.circles.size==0){
				circlesLoaded = false; 
				return false;
			}
			circles = data.values.circles;
		}

		function save(id){
			alert("Not yet implemented. Your id: "+id);
		}

		$(document).ready(function() {
			checkLogin();
			setSearchAnimation();
			getUserData({onSuccess: function(data){loadUserInfo(data);}});
			loadRecords({onSuccess: function(data){loadLatestRecords(data);}, onError: function(){loadRecordsError();}});
			loadCircles({onSuccess: function(data){loadedCircles(data);}, onError: function(){console.log("Error while loading circles..."); circlesLoaded=false;}});
			$("#logoutButton").click(function(){
				logout();
				return false;
			});
			$("#createRecButton").click(function(){
				window.location = WEB_URL+"apps/addRecordApp.html"; 
				return false;
			});
			$("#userInfo").click(function(){
				window.location = WEB_URL+"profile.html";
				return false;
			});
			$( "#close, #dialog-overlay" ).click(function() {
				$("#circles-form, #dialog-overlay").hide();
				return false;
			});
			$( "#save" ).click(function() {
				save($("#recordID").val());
				return false;
			});
			$("#newTabIcon").click(function(){
				alert("Not yet implemented. \nWhen this is done, you shall see a dialog to create a new spaces tab and fill it with content.");
			});
			$("#search").keyup(function(event){
			    if(event.keyCode == 13){
			    	if($("#search").val()!=undefined && $("#search").val().length>0){
			    		if(typeof(Storage)!=="undefined") {
							localStorage.setItem("hb_query", $("#search").val());
						}
			        	window.location = WEB_URL + "queryResult.html?";
			       	}
			    }
			});
		});
		
	</script>
</head>
<body>
	<div class="dialog-overlay" id="dialog-overlay"></div>
	<div id="circles-form" class="profile-dialog-form dialog-front spaces-dialog" title="Set Circles">
		<p class="dialog-front dialog-header">By selecting a Cicle all people you put into this very circle will be able to inspect this record.</p>
		<br/>
		<form class="dialog-content dialog-front">
			<input type="hidden" id="recordID" value="" />
			<div>
				<label for="circle" class="label">Circles</label>
				<select id="circle" name="gender" class="input" require>
				</select>
			</div>
			<br/>
			<div class="dialog-button dialog-front">
				<button class="button dialog-front dialogButton" id="save">Save</button>
				<button class="button dialog-front dialogButton" id="close">Close</button>
			</div>
		</form>
	</div>
	<!--Page-->
	<div id="hb-page">
		<div class="page-container">
			<!--Header-->
			<div class="page-header">
				<h1>Your health record</h1> 
				<div class="page-actionbox">
					<span id="userInfo" class="userInfo"></span>
					<input id="logoutButton" type="submit" name="submit" value="Logout" class="page-logout-button" />
					<div class="searchbox">
						<span id="searchIconSpan"><img id="searchIcon" src="../../images/search-icon.png"/></span>
						<input id="search" type="text" x-webkit-speech/>
					</div>
				</div>
			</div>
			<!--END Header-->

			<div class="page-content-container">
				<!--Navi-->
				<ul id="navivation" class="page-navi">
					<li><a href="../home.html">Home</a></li>
					<li><a href="../profile.html">Profile</a></li>
					<li class="selectedLi"><a href="spaces.html">Spaces</a></li>
					<li><a href="../circles.html">Circles</a></li>
					<li><a href="../apps.html">Apps</a></li>
					<li><a href="../community.html">Community</a></li>
					<li><a href="../about.html">About</a></li>
				</ul>
				<!--END Navi-->

				<!--Content-->
				<div id="tabs" class="tabs">
					<div id="all" class="tab tab-highlight"><a href="spaces.html">All Entries</a></div>
					<div id="medical" class="tab"><a href="medicalTimeline.html">Medical</a></div>
					<div id="wellness" class="tab"><a href="wellnessTimeline.html">Wellness</a></div>
					<div id="calories" class="tab"><a href="caloriesTimeline.html">Calories</a></div>
					<div id="newtab" class="tab new-tab"><img id="newTabIcon" src="../../images/plus.png" width="18px"/></div>
				</div>
				<div class="page-content spaces-page-content">
					<div id="chronic-section">
						<div class="chronic-section-header">
							<h3 class="header-text">Your latest records</h3>
							<input id="createRecButton" type="submit" name="submit" value="Create New Record" class="big-button" />
						</div>
						<br/>
						<ul id="recordentries" class="recordentries">
							<center>
								<img style="height:60px; float:center; display: block; margin-left: auto; margin-right: auto;" src="../../images/loading.gif"></img>
								Loading...
							</center>
						</ul>
					</div>
				</div>
				<!--END Content-->
			</div>
		</div>
	</div>
	<!--END Page-->
	
	<!--Bg Gradient--><div class="gradient-page"></div><!--END Bg Gradient-->
	
	<!-- Bottom Bar -->
    <div class="hb-bottom">
		<span class="disclaimer">This is a project by Health Bank<sup>&copy;</sup>. All rights reserved. This website was elaborated by Patrick Tremp for his Master thesis.<span>
    	
        <span class="right">
    		<a href="http://www.healthbank.ch">
    			<img src="../../images/logo.png" style=" margin-top:6px; height: 80%;" title="To Health Bank" alt="ETHZ" />
    		</a>
    	</span>
    	<div class="clr"></div>
    </div>
	<!--END Bottom Bar -->
</body>
</html>